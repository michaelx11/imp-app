<% provide(:title, "Shopping Runs") %>
<div class="page-header well">
    <h1>Pending Requests</h1>
</div>
<div class="row-fluid">

    <table class="display" id="requests-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>MEAL</th>
                <th>Cook</th>
                <th>Materials Needed</th>
                <% if is_admin? %>
                    <th></th>
                    <th></th>
                    <th></th>
                <% end %>
                <% if signed_in? %>
                    <th></th>
                <% end %>
            </tr>
        </thead>
        <tbody>
            <% MealEvent.each do |meal_event| %>
                <% unless has_shopper?(meal_event) %>
                    <tr>
                        <td> <%= meal_event.date %> </td>
                        <td> <%= link_to meal_event.meal.name, meal_event_path(meal_event) %> </td>
                        <td> <%= link_to meal_event.cook.name, user_path(meal_event.cook) %> </td>
                        <td> <%= meal_event.materials %></td>
                        <% if is_admin? %>
                            <td> <%= show_users(meal_event.rsvps) %> </td>
                            <td> <%= show_users(meal_event.late_rsvps) %> </td>
                            <td> <%= show_users(meal_event.customers) %> </td>
                        <% end %>
                        <% if signed_in? %>
                            <td>
                                <li id="fat-menu" class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown"> Buy Supplies</a>
                                <ul id="dropdown" class="dropdown-menu">
                                    <!-- DROPDOWN MENU OF ALL POSSIBLE SHOPPING RUNS -->
                                    <% if is_admin? %>
                                        <% shopping_runs = ShoppingRun.all %>
                                    <% else %>
                                        <% shopping_runs = current_user.shopping_runs %>
                                    <% end %>
                                    <% if shopping_runs.empty? %>
                                        <li >No scheduled shopping runs.</li>
                                    <% else %>
                                        <% shopping_runs.each do |shopping_run| %>
                                            <li ><%= link_to ('buy on ' + shopping_run.date.to_s), new_shopping_request_path({:meal_event => meal_event.id, :shopping_run => shopping_run.id}) %></li>
                                        <% end %>
                                    <% end %>
                                    <!-- -->
                                </ul>
                            </td>
                        <% end %>
                    </tr>
                <% end %>
            <% end %>
        </tbody>
    </table>
</div>

<hr></hr>

<div class="page-header well">
    <h1><%= yield(:title) %></h1>
</div>
<div class="row-fluid">

    <table class="display" id="shopping-runs-table">
        <thead>
            <tr>
                <th>Status</th>
                <th>Date</th>
                <th>Requests</th>
                <th>Shopper</th>
                <% if is_admin? %>
                    <th>Cost</th>
                <% end %>
                <th></th>
                <th></th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            <% @shopping_runs.each do |shopping_run| %>
                <tr>
                    <td> <%= link_to shopping_run_status_text(shopping_run), shopping_run_path(shopping_run) %> </td>
                    <td> <%= shopping_run.date %> </td>
                    <td> <%= shopping_run.meal_events.map(&:meal).map(&:name).join(', ') %> </td>
                    <td> <%= link_to shopping_run.shopper.name, user_path(shopping_run.shopper) %> </td>
                    <% if is_admin? %>
                        <td> <%= shopping_run.cost %> </td>
                    <% end %>
                    <% if shopping_run.pending && current_user?(shopping_run.shopper) %>
                        <td> <%= link_to "Mark Completed", new_shopping_complete_path(:shopping_run => shopping_run.id) %> </td>
                    <% else %>
                        <td></td>
                    <% end %>
                    <% if current_user?(shopping_run.shopper) || is_admin? %>
                        <td> <%= link_to 'Edit', edit_shopping_run_path(shopping_run) %> </td>
                        <td> <%= link_to 'Remove', shopping_run, :method => :delete, :data => { :confirm => "Are you sure?" } %> </td>
                    <% else %>
                        <td></td>
                        <td></td>
                    <% end %>
                </tr>
            <% end %>
        </tbody>
    </table>
</div>

<br />

<% if signed_in? %>
    <%= link_to 'New Shopping Run', new_shopping_run_path, :class => "btn btn-large" %>
<% end %>
<hr />

<script>
    $(document).ready(function() {
        $("#requests-table").dataTable();
        $("#shopping-runs-table").dataTable();
    });
    
    $.extend( $.fn.dataTableExt.oStdClasses, {
        "sWrapper": "dataTables_wrapper form-inline"
    });
</script>
